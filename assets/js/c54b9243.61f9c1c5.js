"use strict";(self.webpackChunkcnoe=self.webpackChunkcnoe||[]).push([[7219],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),g=i,m=u["".concat(s,".").concat(g)]||u[g]||d[g]||r;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=g;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:i,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},1161:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=n(7462),i=(n(7294),n(3905));const r={sidebar_position:5,description:"Using the built-in OCI registry",title:"Local OCI Registry",index:5},o=void 0,l={unversionedId:"reference-implementation/installations/idpbuilder/local-oci-registry",id:"reference-implementation/installations/idpbuilder/local-oci-registry",title:"Local OCI Registry",description:"Using the built-in OCI registry",source:"@site/docs/reference-implementation/installations/idpbuilder/local-oci-registry.md",sourceDirName:"reference-implementation/installations/idpbuilder",slug:"/reference-implementation/installations/idpbuilder/local-oci-registry",permalink:"/docs/reference-implementation/installations/idpbuilder/local-oci-registry",draft:!1,editUrl:"https://github.com/cnoe-io/website/tree/main/docs/reference-implementation/installations/idpbuilder/local-oci-registry.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,description:"Using the built-in OCI registry",title:"Local OCI Registry",index:5},sidebar:"tutorialSidebar",previous:{title:"Override built-in services",permalink:"/docs/reference-implementation/installations/idpbuilder/override"},next:{title:"Troubleshooting",permalink:"/docs/reference-implementation/installations/idpbuilder/troubleshooting"}},s={},c=[{value:"Path Based Routing",id:"path-based-routing",level:3},{value:"Image Tags",id:"image-tags",level:3},{value:"Pulling Images",id:"pulling-images",level:3},{value:"No Pull Secret Needed",id:"no-pull-secret-needed",level:4},{value:"Referencing Images In Manifests On The Idpbuilder K8s Cluster",id:"referencing-images-in-manifests-on-the-idpbuilder-k8s-cluster",level:3},{value:"Pulling Images From Inside Idpbuilder K8s Cluster:",id:"pulling-images-from-inside-idpbuilder-k8s-cluster",level:3},{value:"Codespaces tips and tricks",id:"codespaces-tips-and-tricks",level:3},{value:"Example mirroring Alpine image",id:"example-mirroring-alpine-image",level:4},{value:"Transferring images from remote registries to idbpbuilder",id:"transferring-images-from-remote-registries-to-idbpbuilder",level:3}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,'The local Gitea instance created by idpbuilder contains a built-in OCI registry for hosting container images as "packages" in Gitea nomenclature.'),(0,i.kt)("p",null,"It is a standard OCI registry, so the API should be compatible with any tools that are OCI compliant. That includes the ",(0,i.kt)("inlineCode",{parentName:"p"},"docker")," cli."),(0,i.kt)("p",null,"For example, you can push an image by running:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker login gitea.cnoe.localtest.me:8443                                          \n# see the note section below for retrieving your password.\nUsername: giteaAdmin\nPassword: \n\n# you can build your own image instead of pulling.\ndocker pull docker.io/library/ubuntu:24.04 \ndocker tag docker.io/library/ubuntu:24.04 gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n\ndocker push gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"NOTE"),": You can get the giteaAdmin password in the same way as you do for the web or git interface."),(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("inlineCode",{parentName:"p"},"idpbuilder get secrets -p gitea")),(0,i.kt)("p",{parentName:"blockquote"},"Or you can use this to login directly:"),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre"},"idpbuilder get secrets -p gitea -o json | \\\n  jq '.[0].data.password' -r | \\\n  docker login -u giteaAdmin --password-stdin gitea.cnoe.localtest.me:8443\n"))),(0,i.kt)("h3",{id:"path-based-routing"},"Path Based Routing"),(0,i.kt)("p",null,"You can also use the OCI registry with path based routing mode (the ",(0,i.kt)("inlineCode",{parentName:"p"},"--use-path-routing")," flag).\nWhen using this flag, you need to specify the host as ",(0,i.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me:8443"),"."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# get the admin user password\nidbuilder get secrets -p gitea\n\n# login\ndocker login cnoe.localtest.me:8443\n# Username (giteaAdmin): giteaAdmin\n# Password:\n\n# test with the ubuntu 24.04 image\ndocker pull docker.io/library/ubuntu:24.04 \ndocker tag docker.io/library/ubuntu:24.04 cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\ndocker push cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n\n")),(0,i.kt)("h3",{id:"image-tags"},"Image Tags"),(0,i.kt)("p",null,"Images pushed to Gitea OCI registry must be tagged with the following naming convention: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"{registry}/{owner}/{image}\n")),(0,i.kt)("p",null,"For example: ",(0,i.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04")),(0,i.kt)("p",null,"This is a naming convention enforced by Gitea. Please see ",(0,i.kt)("a",{parentName:"p",href:"https://docs.gitea.com/usage/packages/container"},"the Gitea documentation")," for more information."),(0,i.kt)("h3",{id:"pulling-images"},"Pulling Images"),(0,i.kt)("p",null,"You can pull an image back to your local machine using your docker client like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker pull gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n")),(0,i.kt)("h4",{id:"no-pull-secret-needed"},"No Pull Secret Needed"),(0,i.kt)("p",null,"The Gitea instance allows for anonymous read access. This means that you can pull git repo contents and container images without logging in."),(0,i.kt)("h3",{id:"referencing-images-in-manifests-on-the-idpbuilder-k8s-cluster"},"Referencing Images In Manifests On The Idpbuilder K8s Cluster"),(0,i.kt)("p",null,"You can create a pod or a deployment that references images in the local registry. For example, to create a pod:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\n  namespace: default\n  name: debug-pod\nspec:\n  containers:\n    - image: gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n      name: debug-pod\n      command:\n        - sleep\n        - "3600"\n')),(0,i.kt)("h3",{id:"pulling-images-from-inside-idpbuilder-k8s-cluster"},"Pulling Images From Inside Idpbuilder K8s Cluster:"),(0,i.kt)("p",null,"Because we are using an NGINX Ingress and pushing our image from off cluster,\nGitea and its OCI registry think all images pushed to it are prefixed with ",(0,i.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me:8443"),"."),(0,i.kt)("p",null,"This is correct by the OCI spec standards. However, when you are on the cluster, that ingress is not available to you.\nYou can use the service name of gitea, but gitea will not know what images are being asked for at the svc domain name. To work around this issue, we use containerd to rewrite those image names so that they can be referenced at the external url:"),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/cnoe-io/idpbuilder/blob/main/pkg/kind/resources/kind.yaml.tmpl"},"the Kind config")," for how this is done."),(0,i.kt)("h3",{id:"codespaces-tips-and-tricks"},"Codespaces tips and tricks"),(0,i.kt)("p",null,"By default all port forwarding in a Codespace environment is private which means that you will not be able to access the OCI registry directly from your local machine's CLI."),(0,i.kt)("p",null,"You can however use the github CLI to port-forward a port on your local machine to the codespace which is running the OCI registry and listening on port 8443."),(0,i.kt)("p",null,"To do this, make sure you have the latest github cli installed. Instructions here: ","[https://github.com/cli/cli#installation]"," (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/cli/cli#installation"},"https://github.com/cli/cli#installation"),")"),(0,i.kt)("p",null,"Next you will need to login to github and give your CLI access to the codespace:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"$ gh auth login -h github.com -s codespace\n")),(0,i.kt)("p",null,"Follow the prompts to perform the auth via your local machine's browser and make sure to choose the codespace you are running idpbuilder in."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gh auth login -h github.com -s codespace\n! First copy your one-time code: 0076-1071\nPress Enter to open https://github.com/login/device in your browser... \nOpening in existing browser session.\n\u2713 Authentication complete.\n")),(0,i.kt)("p",null,"List the ports on your codespace:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gh codespace ports\n? Choose codespace: cnoe-io/idpbuilder [main*]: expert chainsaw\nLABEL  PORT   VISIBILITY  BROWSE URL                                                 \n       8443   private     https://expert-chainsaw-7vjwj6qqgcprjp-8443.app.github.dev\n       37065  private     https://expert-chainsaw-7vjwj6qqgcprjp-37065.app.github.dev\n")),(0,i.kt)("p",null,"Then perform the port-forward. Make sure to use the same port that the codespace has listed in it's port column. Likely this is 8443 which is the default at the time of this writing."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gh codespace ports forward 8443:8443 -c expert-chainsaw-7vjwj6qqgcprjp\n")),(0,i.kt)("p",null,"If you see a message like the following then you may already have another service on your local machine that is listening on 8443. Make sure to shut it down. (Maybe you were running idpbuilder locally as well?)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"failed to listen to local port over tcp: listen tcp :8443: bind: address already in use\n")),(0,i.kt)("p",null,"Once you have setup the port-forward you will see the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ gh codespace ports forward 8443:8443 -c expert-chainsaw-7vjwj6qqgcprjp\nForwarding ports: remote 8443 <=> local 8443\n")),(0,i.kt)("p",null,"You can now connect directly to the registry hosted on idpbuilder in your codespace environment."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker login cnoe.localtest.me:8443/gitea                            \nAuthenticating with existing credentials...\nStored credentials invalid or expired\nUsername (giteaAdmin): giteaadmin\nPassword: \nWARNING! Your password will be stored unencrypted in /home/sanforj/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credential-stores\n\nLogin Succeeded\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"IMPORTANT!")," As you may have noticed, you must use ",(0,i.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me:8443")," (or whatever port number was listed) as the registry name."),(0,i.kt)("p",null,"This will allow for compatibility with the oci clients that are working in the codespace as well as those that are running on the idpbuilder kubernetes cluster.\nAs long as you tag your images and push them to ",(0,i.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me:8443/gitea/giteaadmin/imagename:tag")," they will be able to be referenced on your local machine, on the cli within the codespace and on the idbpuilder k8s cluster at that same registry/repo/imagename:tag location."),(0,i.kt)("h4",{id:"example-mirroring-alpine-image"},"Example mirroring Alpine image"),(0,i.kt)("p",null,"So to be clear. On your local machine you have to tag your images appropriately like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker tag alpine:latest cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\n")),(0,i.kt)("p",null,"Then you can push once your port-forwarding is working:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker push cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\nThe push refers to repository [cnoe.localtest.me:8443/gitea/giteaadmin/alpine]\n3e01818d79cd: Layer already exists \nlatest: digest: sha256:fa7042902b0e812e73bbee26a6918a6138ccf6d7ecf1746e1488c0bd76cf1f34 size: 527\n")),(0,i.kt)("p",null,"Then on the cli inside your codespace you can pull it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\nlatest: Pulling from gitea/giteaadmin/alpine\nDigest: sha256:fa7042902b0e812e73bbee26a6918a6138ccf6d7ecf1746e1488c0bd76cf1f34\nStatus: Image is up to date for cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\ncnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\n")),(0,i.kt)("p",null,"And when you run an image in your idpbuilder k8s cluster just make sure to reference it at the same location:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Pod\nmetadata:\n  name: alpine-from-local-registry\nspec:\n  containers:\n  - name: alpine-from-local-registry\n    image: cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\n  restartPolicy: Never\n")),(0,i.kt)("h3",{id:"transferring-images-from-remote-registries-to-idbpbuilder"},"Transferring images from remote registries to idbpbuilder"),(0,i.kt)("p",null,"Now that you have a registry up and running at ",(0,i.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me:8443")," you can copy your images to it."),(0,i.kt)("p",null,"This is especially convenient if you want to pre-load a number of images from some remote before going offline."),(0,i.kt)("p",null,"You can also use this technique to load images into codespaces that are behind a corporate firewall."),(0,i.kt)("p",null,"To make this even easier, you can use a tool like ",(0,i.kt)("a",{parentName:"p",href:"https://oras.land"},"ORAS")," or ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/regclient/regclient"},"regclient")," to copy between them"),(0,i.kt)("p",null,"These tools are beyond the scope of this help document, but at the time of this writing a simple copy command using regclient looks like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'$ regctl registry login cnoe.localtest.me:8443               \nEnter Username [giteaadmin]: giteaadmin\nEnter Password:\n\n$ regctl registry set cnoe.localtest.me:8443 --tls=insecure\ntime=2024-12-29T21:50:58.354-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=insecure host=cnoe.localtest.me:8443\n\n$ regctl image copy docker.io/library/alpine:latest cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\ntime=2024-12-29T21:50:07.489-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=disabled host=expert-chainsaw-7vjwj6qqgcprjp-8443.app.github.dev\ntime=2024-12-29T21:50:07.489-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=insecure host=cnoe.localtest.me:8443\nManifests: 17/17 | Blobs: 0.000B copied, 0.000B skipped | Elapsed: 0s\ncnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\n')))}u.isMDXComponent=!0}}]);