"use strict";(self.webpackChunkcnoe=self.webpackChunkcnoe||[]).push([[1656],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=p(n),d=s,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||r;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,i=new Array(r);i[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[m]="string"==typeof e?e:s,i[1]=o;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2183:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(7462),s=(n(7294),n(3905));const r={sidebar_position:1,description:"Augmenting CNOE with CRD templates",title:"Templating of CRDs / XRDs"},i=void 0,o={unversionedId:"reference-implementation/extensions/crd-templating",id:"reference-implementation/extensions/crd-templating",title:"Templating of CRDs / XRDs",description:"Augmenting CNOE with CRD templates",source:"@site/docs/reference-implementation/extensions/crd-templating.md",sourceDirName:"reference-implementation/extensions",slug:"/reference-implementation/extensions/crd-templating",permalink:"/docs/reference-implementation/extensions/crd-templating",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/reference-implementation/extensions/crd-templating.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,description:"Augmenting CNOE with CRD templates",title:"Templating of CRDs / XRDs"},sidebar:"tutorialSidebar",previous:{title:"Extensions",permalink:"/docs/reference-implementation/extensions/"},next:{title:"Templating of Terraform Modules",permalink:"/docs/reference-implementation/extensions/tf-templating"}},l={},p=[{value:"Template Generation",id:"template-generation",level:2},{value:"Example",id:"example",level:2},{value:"Custom Resource Definitions",id:"custom-resource-definitions",level:3},{value:"The Backstage Scaffolding Template",id:"the-backstage-scaffolding-template",level:3},{value:"Conversion",id:"conversion",level:3},{value:"Importing to Backstage",id:"importing-to-backstage",level:3}],c={toc:p},m="wrapper";function u(e){let{components:t,...r}=e;return(0,s.kt)(m,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"The CNOE CLI allows you to create Backstage developer workflows from existing Kubernetes\nCustom Resource Definitions (CRDs) and Crossplane Composite Resource Definitions\n(XRDs). "),(0,s.kt)("admonition",{type:"tip"},(0,s.kt)("p",{parentName:"admonition"},"This is proven particularly useful for in-house Kubernetes controllers for which there\nis a need for integration with Backstage.")),(0,s.kt)("h2",{id:"template-generation"},"Template Generation"),(0,s.kt)("p",null,"As shown below, the ",(0,s.kt)("inlineCode",{parentName:"p"},"./cnoe template crd")," command allows you to specify an input\ndirectory for stored CRD specifications, the template that needs to be populated\nwith the list of converted CRDs, definings whether or not the\nCRD is cluster-scoped or namespace-scoped, and configuration knobs to set the\nname, title, and description of the generated template."),(0,s.kt)("p",null,"The generated templates are stored in the defined output directory."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'Generate backstage templates from supplied CRD and XRD definitions\n\nUsage:\n  cnoe template crd [flags]\n\nFlags:\n  -h, --help                         help for crd\n  -n, --namespaced                   whether or not resources are namespaced\n      --templateDescription string   sets the description of the template\n      --templateName string          sets the name of the template\n  -t, --templatePath string          path to the template to be augmented with backstage info (default "scaffolding/template.yaml")\n      --templateTitle string         sets the title of the template\n  -v, --verifier stringArray         list of verifiers to test the resource against\n\nGlobal Flags:\n  -i, --inputDir string    input directory for CRDs and XRDs to be templatized\n  -o, --outputDir string   output directory for backstage templates to be stored in\n')),(0,s.kt)("h2",{id:"example"},"Example"),(0,s.kt)("p",null,"You require the list of CRDs that you want to convert, and a Backstage template:"),(0,s.kt)("h3",{id:"custom-resource-definitions"},"Custom Resource Definitions"),(0,s.kt)("p",null,"For this example, let us look at the CRDs available in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/cnoe-io/cnoe-cli/tree/main/examples"},"CNOE CLI repository"),".\nIn particular, the CRDs for ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/aws-controllers-k8s"},"Amazon Controllers for\nKubernetes (ACK)"),".\nThere is approximately 120 sample ACK CRDs in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/cnoe-io/cnoe-cli/tree/main/examples/ack-crds"},"example repo"),"."),(0,s.kt)("h3",{id:"the-backstage-scaffolding-template"},"The Backstage Scaffolding Template"),(0,s.kt)("p",null,"You can choose a scaffolding template of your choice to pass to the tool for it\nto augment it with the list of converted CRD elements. For this example we\nchoose the\n",(0,s.kt)("a",{parentName:"p",href:"https://github.com/cnoe-io/cnoe-cli/blob/main/config/templates/k8s-apply-template.yaml"},"k8s-apply-template"),"\navailable in the CNOE CLI repository."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: scaffolder.backstage.io/v1beta3\nkind: Template\nmetadata:\n  name: deploy-resources\n  title: Deploy Resources\n  description: Deploy Resource to Kubernetes\nspec:\n  owner: guest\n  type: service\n  # these are the steps which are rendered in the frontend with the form input\n  parameters:\n    - title: Choose AWS Resources\n      description: Select a AWS resource to add to your repository.\n      properties:\n        path:\n          type: string\n          description: path to place this file into\n          default: kustomize/base\n        name:\n          type: string\n          description: name of this resource. This will be the name of K8s object.\n      required:\n        - awsResources\n        - name\n  steps:\n  - id: serialize\n    name: serialize\n    action: roadiehq:utils:serialize:yaml\n    input:\n      data:\n        apiVersion: ${{ parameters.apiVersion }}\n        kind: ${{ parameters.kind }}\n        metadata:\n          name: ${{ parameters.name }}\n          namespace: ${{ parameters.namespace }}\n        spec: ${{ parameters.config }}\n  - id: sanitize\n    name: sanitize\n    action: cnoe:utils:sanitize\n    input:\n      document: ${{ steps['serialize'].output.serialized }}\n  - id: apply\n    name: apply-manifest\n    action: cnoe:kubernetes:apply\n    input:\n      namespaced: true\n      manifest: ${{ steps['sanitize'].output.sanitized }}\n")),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"metadata")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"spec.parameters")," elements are placeholders that will be\noverwritten by the tool when doing the conversion. However, the ",(0,s.kt)("inlineCode",{parentName:"p"},"steps")," remain\nas the primary set of actions later on to be taken by Backstage to deploy the\ngenerated templates."),(0,s.kt)("p",null,"The set of steps for the scaffolder are pretty self explanatory but stating the\nobvious, the first two steps ",(0,s.kt)("inlineCode",{parentName:"p"},"serialize")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"sanitize")," the yaml document corresponding\nto the converted CRD, and the last step deploys the CRD to a target Kubernetes\ncluster."),(0,s.kt)("h3",{id:"conversion"},"Conversion"),(0,s.kt)("p",null,"Run the command below:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'\u276f cd ~/cnoe-cli\n\u276f ./cnoe template crd \\\n  --inputDir examples/ack-crds \\\n  --outputDir /tmp/templates-ack-deploy \\\n  --templatePath config/templates/k8s-apply-template.yaml \\\n  --namespaced \\\n  --templateName deploy-ack-resource \\\n  --templateTitle "Deploy ACK Resource" \\\n  --templateDescription "Deploy ACK Resource to Kubernetes"\n')),(0,s.kt)("p",null,"The output in the ",(0,s.kt)("inlineCode",{parentName:"p"},"/tmp/templates-ack-deploy")," should look like below:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"drwxr-xr-x  119 user  wheel   3.7K Aug  7 23:26 resources\ndrwxr-xr-x    4 user  wheel   128B Aug  7 23:26 .\n-rw-r--r--    1 user  wheel    15K Aug  8 19:25 template.yaml\ndrwxrwxrwt   68 root  wheel   2.1K Aug  8 19:34 ..\n")),(0,s.kt)("p",null,"With the template augmented to have all the resoruces:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"redepiVersion: scaffolder.backstage.io/v1beta3\nkind: Template\nmetadata:\n  name: deploy-ack-resource\n  title: Deploy ACK Resource\n  description: Deploy Resource to Kubernetes\nspec:\n  owner: guest\n  type: service\n  parameters:\n  - properties:\n      name:\n        description: name of this resource. This will be the name of K8s object.\n        type: string\n      path:\n        default: kustomize/base\n        description: path to place this file into\n        type: string\n      resources:\n        type: string\n        enum:\n        - acm.services.k8s.aws.Certificate\n        - apigatewayv2.services.k8s.aws.API\n        - apigatewayv2.services.k8s.aws.Authorizer\n        - apigatewayv2.services.k8s.aws.Deployment\n        - apigatewayv2.services.k8s.aws.Integration\n        - apigatewayv2.services.k8s.aws.Route\n        - apigatewayv2.services.k8s.aws.Stage\n        - apigatewayv2.services.k8s.aws.VPCLink\n        - applicationautoscaling.services.k8s.aws.ScalableTarget\n        - applicationautoscaling.services.k8s.aws.ScalingPolicy\n        - cloudfront.services.k8s.aws.CachePolicy\n        - cloudtrail.services.k8s.aws.EventDataStore\n        - cloudtrail.services.k8s.aws.Trail\n        ...\n    dependencies:\n      resources:\n        oneOf:\n        - $yaml: resources/acm.services.k8s.aws.certificate.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.api.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.authorizer.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.deployment.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.integration.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.route.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.stage.yaml\n        - $yaml: resources/apigatewayv2.services.k8s.aws.vpclink.yaml\n        - $yaml: resources/applicationautoscaling.services.k8s.aws.scalabletarget.yaml\n        - $yaml: resources/applicationautoscaling.services.k8s.aws.scalingpolicy.yaml\n        - $yaml: resources/cloudfront.services.k8s.aws.cachepolicy.yaml\n        - $yaml: resources/cloudtrail.services.k8s.aws.eventdatastore.yaml\n        - $yaml: resources/cloudtrail.services.k8s.aws.trail.yaml\n        ...\n  steps:\n  - id: serialize\n    name: serialize\n    action: roadiehq:utils:serialize:yaml\n    input:\n      data:\n        apiVersion: ${{ parameters.apiVersion }}\n        kind: ${{ parameters.kind }}\n        metadata:\n          name: ${{ parameters.name }}\n          namespace: ${{ parameters.namespace }}\n        spec: ${{ parameters.config }}\n  - id: sanitize\n    name: sanitize\n    action: cnoe:utils:sanitize\n    input:\n      document: ${{ steps['serialize'].output.serialized }}\n  - id: apply\n    name: apply-manifest\n    action: cnoe:kubernetes:apply\n    input:\n      manifest: ${{ steps['sanitize'].output.sanitized }}\n      namespaced: true\n\n")),(0,s.kt)("h3",{id:"importing-to-backstage"},"Importing to Backstage"),(0,s.kt)("p",null,"The generated template can then registered with Backstage by pushing it to a\nrepository and analyzing the generated content.  With a valid template,\nthe analysis would be successfully validated and you can import the template\ninto Backstage."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"import",src:n(653).Z,width:"721",height:"490"})),(0,s.kt)("p",null,'It would show up in the list of available templates (in this case the service\ntemplate to "Deploy ACK Resources"):'),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"navigate",src:n(3881).Z,width:"1308",height:"586"})),(0,s.kt)("p",null,"Choosing the template would load all the resources dynamically generated for the\ntemplate. In case of Amazon Controller for Kubernetes (ACK), it will be the list\nof over 180 resources that we created from the available CRDs."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"load",src:n(1100).Z,width:"1314",height:"631"})),(0,s.kt)("p",null,"Once the desired resource is selected, the Backstage UI will be populated with\nthe list of all properties that can be configured for this CRD, with the\nBackstage template validating the presence of required properties before you can\nproceed:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"init",src:n(4321).Z,width:"1313",height:"1191"})),(0,s.kt)("p",null,"Once the properties are defined, the resource is hydrated for deployment to\nKubernetes:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"create",src:n(881).Z,width:"1309",height:"770"})),(0,s.kt)("p",null,"Where deploying the resource will result in running the Backstage scaffolder and\ngetting the resource deployed to a target cluster as configured in your\ntemplate:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"deploy",src:n(1475).Z,width:"789",height:"472"})))}u.isMDXComponent=!0},653:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2-import-template-3f5406bff4996c5a8f80307ebb9f21f7.png"},3881:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/3-navigate-catalog-c9ca1ea250aa9a2dbcef1a509fcdaddc.png"},1100:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/4-load-resource-3e699b611322192a9864ecb646a00eba.png"},4321:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/5-init-resource-5643b5a08848f148a6426c92294a8830.png"},881:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/6-create-resource-7c9af188d865f85aa05c2a562e24f423.png"},1475:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/7-deploy-resource-6cb3b585e1ceec63c255becc25d60356.png"}}]);