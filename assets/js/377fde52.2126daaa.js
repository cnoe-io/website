"use strict";(self.webpackChunkcnoe=self.webpackChunkcnoe||[]).push([[8878],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),c=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},g=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(n),g=a,m=u["".concat(s,".").concat(g)]||u[g]||p[g]||r;return n?i.createElement(m,o(o({ref:t},d),{},{components:n})):i.createElement(m,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=g;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}g.displayName="MDXCreateElement"},7284:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var i=n(7462),a=(n(7294),n(3905));const r={sidebar_position:2,description:"idpbuilder Fundamentals",title:"idpbuilder Fundamentals",index:2},o=void 0,l={unversionedId:"intro/idpbuilder/how-it-works",id:"intro/idpbuilder/how-it-works",title:"idpbuilder Fundamentals",description:"idpbuilder Fundamentals",source:"@site/docs/intro/idpbuilder/how-it-works.md",sourceDirName:"intro/idpbuilder",slug:"/intro/idpbuilder/how-it-works",permalink:"/docs/intro/idpbuilder/how-it-works",draft:!1,editUrl:"https://github.com/cnoe-io/website/tree/main/docs/intro/idpbuilder/how-it-works.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,description:"idpbuilder Fundamentals",title:"idpbuilder Fundamentals",index:2},sidebar:"tutorialSidebar",previous:{title:"idpBuilder Overview",permalink:"/docs/intro/idpbuilder/"},next:{title:"Customizing idpbuilder",permalink:"/docs/intro/idpbuilder/override"}},s={},c=[{value:"Security",id:"security",level:2},{value:"Self Signed Certificate",id:"self-signed-certificate",level:3},{value:"Getting Relevant Secrets",id:"getting-relevant-secrets",level:3},{value:"Networking",id:"networking",level:2},{value:"Traffic Flow",id:"traffic-flow",level:3},{value:"DNS Configuration",id:"dns-configuration",level:3},{value:"External DNS Resolution",id:"external-dns-resolution",level:4},{value:"In-cluster DNS Configuration",id:"in-cluster-dns-configuration",level:4},{value:"Routing Modes",id:"routing-modes",level:2},{value:"Domain-based routing",id:"domain-based-routing",level:3},{value:"Path-based routing",id:"path-based-routing",level:3},{value:"Local OCI Registry",id:"local-oci-registry",level:2},{value:"Pushing image",id:"pushing-image",level:3},{value:"Tagging Image",id:"tagging-image",level:3},{value:"Pulling Images",id:"pulling-images",level:3},{value:"No Pull Secret Needed",id:"no-pull-secret-needed",level:4},{value:"Referencing Images In Manifests On The Idpbuilder K8s Cluster",id:"referencing-images-in-manifests-on-the-idpbuilder-k8s-cluster",level:3},{value:"Pulling Images From Inside Idpbuilder K8s Cluster:",id:"pulling-images-from-inside-idpbuilder-k8s-cluster",level:3},{value:"Transferring images from remote registries to idbpbuilder",id:"transferring-images-from-remote-registries-to-idbpbuilder",level:3}],d={toc:c};function u(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,i.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"security"},"Security"),(0,a.kt)("h3",{id:"self-signed-certificate"},"Self Signed Certificate"),(0,a.kt)("p",null,"To ensure applications inside the cluster can talk to other services, idpbuilder creates a self-signed TLS certificate. The certificate is a wild card certificate\nfor the domain name and any subdomains given by the ",(0,a.kt)("inlineCode",{parentName:"p"},"--host")," flag.\nFor example, if you use the default domain name ",(0,a.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me")," the certificate is issued for ",(0,a.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"*.cnoe.localtest.me")),(0,a.kt)("p",null,"This certificate is then used by ingress-nginx as ","[the default TLS certificate]","(",(0,a.kt)("a",{parentName:"p",href:"https://kubernetes.github.io/ingress-nginx/user-guide/tls/#default-ssl-certificate"},"https://kubernetes.github.io/ingress-nginx/user-guide/tls/#default-ssl-certificate"),"_. This means you can override TLS certificate used at ingress level if desired."),(0,a.kt)("p",null,"The certificate is also ",(0,a.kt)("a",{parentName:"p",href:"https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#repositories-using-self-signed-tls-certificates-or-are-signed-by-custom-ca"},"imported to ArgoCD")," as one of trusted CAs. This is necessary to make sure ArgoCD can talk to Gitea services without disabling TLS."),(0,a.kt)("p",null,"Finally, the certificate is exposed as a secret named ",(0,a.kt)("inlineCode",{parentName:"p"},"idpbuilder-cert")," in the default namespace. To retrieve it, run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get secret -n default idpbuilder-cert\n")),(0,a.kt)("h3",{id:"getting-relevant-secrets"},"Getting Relevant Secrets"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"idpbuilder get secrets")," command retrieves the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ArgoCD initial admin password."),(0,a.kt)("li",{parentName:"ul"},"Gitea admin user credentials."),(0,a.kt)("li",{parentName:"ul"},"Any secrets labeled with ",(0,a.kt)("inlineCode",{parentName:"li"},"cnoe.io/cli-secret=true"),".")),(0,a.kt)("p",null,"You can think of the command as executing the following kubectl commands:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl -n argocd get secret argocd-initial-admin-secret\nkubectl get secrets -n gitea gitea-admin-secret\nkubectl get secrets -A -l cnoe.io/cli-secret=true\n")),(0,a.kt)("p",null,"If you want to retrieve secrets for a package, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"-p")," flag. To get secrets for a package named ",(0,a.kt)("inlineCode",{parentName:"p"},"gitea"),": "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"idpbuilder get secrets -p gitea\n")),(0,a.kt)("p",null,"For the ",(0,a.kt)("inlineCode",{parentName:"p"},"-p")," flag to work, you must label the secret with ",(0,a.kt)("inlineCode",{parentName:"p"},"cnoe.io/package-name"),".\nFor example, to make secret values available in a secret named ",(0,a.kt)("inlineCode",{parentName:"p"},"my-secret")," for a package named ",(0,a.kt)("inlineCode",{parentName:"p"},"foo"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl label secret my-secret "cnoe.io/package-name=foo" "cnoe.io/cli-secret=true"\n')),(0,a.kt)("p",null,"The secret will then be listed when issuing the ",(0,a.kt)("inlineCode",{parentName:"p"},"idpbuilder get secrets")," command.\nAlternatively, you can use the following command to retrieve the individual secret:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"idpbuilder get secrets -p foo\n")),(0,a.kt)("h2",{id:"networking"},"Networking"),(0,a.kt)("h3",{id:"traffic-flow"},"Traffic Flow"),(0,a.kt)("p",null,"The default Docker-on-Linux configuration for kind cluster establishes the following setup:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A Kubernetes node runs as a Docker container with port 443 mapped to host port 8443. You can confirm this by running ",(0,a.kt)("inlineCode",{parentName:"li"},"docker container ls")),(0,a.kt)("li",{parentName:"ul"},"The ingress-nginx service is configured as NodePort mode, listening on port 443. You can confirm this by running ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl get service -n ingress-nginx ingress-nginx-controller"))),(0,a.kt)("p",null,"When a request is made to ",(0,a.kt)("a",{parentName:"p",href:"https://gitea.cnoe.localtest.me:8443"},"https://gitea.cnoe.localtest.me:8443"),", the traffic flow follows this sequence:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The domain name resolves to the local loopback address"),(0,a.kt)("li",{parentName:"ol"},"A request is sent to ",(0,a.kt)("inlineCode",{parentName:"li"},"127.0.0.1:8443")," with the host header ",(0,a.kt)("inlineCode",{parentName:"li"},"gitea.cnoe.localtest.me:8443")),(0,a.kt)("li",{parentName:"ol"},"The request is forwarded to container port 443"),(0,a.kt)("li",{parentName:"ol"},"Ingress-nginx examines the SNI and host header to route traffic to the Gitea service"),(0,a.kt)("li",{parentName:"ol"},"Gitea processes the request and returns a response\n",(0,a.kt)("img",{alt:"img.png",src:n(9203).Z,width:"907",height:"407"}))),(0,a.kt)("h3",{id:"dns-configuration"},"DNS Configuration"),(0,a.kt)("h4",{id:"external-dns-resolution"},"External DNS Resolution"),(0,a.kt)("p",null,"By default, idpbuilder uses ",(0,a.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me")," as the base domain for exposing services like ArgoCD and Gitea. The ",(0,a.kt)("inlineCode",{parentName:"p"},"localtest.me")," domain and its subdomains automatically resolve to the local loopback address, providing a consistent naming scheme without requiring localhost. For more details, visit ",(0,a.kt)("a",{parentName:"p",href:"https://readme.localtest.me/"},"the localtest.me documentation"),"."),(0,a.kt)("h4",{id:"in-cluster-dns-configuration"},"In-cluster DNS Configuration"),(0,a.kt)("p",null,"To ensure proper name resolution both inside and outside the cluster, idpbuilder configures the cluster's CoreDNS service. While the default domain (cnoe.localtest.me) resolving to ",(0,a.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," works for external access through the NodePort service, it creates challenges for in-cluster communication."),(0,a.kt)("p",null,"For example, when an ArgoCD pod tries to access ",(0,a.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me"),", the address would resolve to the pod's own loopback interface ",(0,a.kt)("inlineCode",{parentName:"p"},"127.0.0.1"),". To address this, idpbuilder configures CoreDNS with rewrite rules like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rewrite name gitea.cnoe.localtest.me ingress-nginx-controller.ingress-nginx.svc.cluster.local\n")),(0,a.kt)("p",null,"This CoreDNS rewrite rule instructs CoreDNS to resolve requests made for ",(0,a.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me")," using the address given by ",(0,a.kt)("inlineCode",{parentName:"p"},"ingress-nginx-controller.ingress-nginx.svc.cluster.local")),(0,a.kt)("h2",{id:"routing-modes"},"Routing Modes"),(0,a.kt)("p",null,"idpbuilder supports two modes of routing requests to in-cluster resources: domain-based and path-based.\nThe behavior is configured with the ",(0,a.kt)("inlineCode",{parentName:"p"},"--use-path-routing")," flag, which defaults to ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,a.kt)("h3",{id:"domain-based-routing"},"Domain-based routing"),(0,a.kt)("p",null,"This is the default behavior of idpbuilder. In this mode, services are exposed under their own domain names.\nFor example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ArgoCD UI is accessed via ",(0,a.kt)("inlineCode",{parentName:"li"},"https://argocd.cnoe.localtest.me")),(0,a.kt)("li",{parentName:"ul"},"Gitea UI is accessed via ",(0,a.kt)("inlineCode",{parentName:"li"},"https://gitea.cnoe.localtest.me"))),(0,a.kt)("p",null,"This approach is generally cleaner and offers more flexible routing options because it requires less complex ingress configurations."),(0,a.kt)("h3",{id:"path-based-routing"},"Path-based routing"),(0,a.kt)("p",null,"When you use the ",(0,a.kt)("inlineCode",{parentName:"p"},"--use-path-routing")," flag, idpbuilder configures all services under a single domain name, with routing based on path parameters.\nFor example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"ArgoCD UI is accessed via ",(0,a.kt)("inlineCode",{parentName:"li"},"https://cnoe.localtest.me/argocd")),(0,a.kt)("li",{parentName:"ul"},"Gitea UI is accessed via ",(0,a.kt)("inlineCode",{parentName:"li"},"https://cnoe.localtest.me/gitea"))),(0,a.kt)("p",null,"This is useful when you are constrained to using a single domain name and cannot use subdomains.\nA good example is when using GitHub Codespaces. When ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/codespaces/developing-in-a-codespace/forwarding-ports-in-your-codespace"},"forwarding ports")," in Codespaces, you are given a single domain name (like ",(0,a.kt)("inlineCode",{parentName:"p"},"wild-broomstick-abc.github.dev"),") to reach all services running in your codespace.\nIn such situations, you cannot use subdomains (e.g., ",(0,a.kt)("inlineCode",{parentName:"p"},"argocd.wild-broomstick-abc.github.dev")," would not work), making path-based routing the appropriate choice."),(0,a.kt)("h2",{id:"local-oci-registry"},"Local OCI Registry"),(0,a.kt)("p",null,'The local Gitea instance created by idpbuilder contains a built-in OCI registry for hosting container images as "packages" in Gitea nomenclature. It is a standard OCI registry, so the API should be compatible with any tools that are OCI compliant. That includes the ',(0,a.kt)("inlineCode",{parentName:"p"},"docker")," cli."),(0,a.kt)("h3",{id:"pushing-image"},"Pushing image"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker login gitea.cnoe.localtest.me:8443                                          \n# see the note section below for retrieving your password.\nUsername: giteaAdmin\nPassword: \n\ndocker pull docker.io/library/ubuntu:24.04 \n# default way\ndocker tag docker.io/library/ubuntu:24.04 gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\ndocker push gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n\n# Pushing image using path based routing. You can also use the OCI registry with path based routing mode (the `--use-path-routing` flag)\n# docker tag docker.io/library/ubuntu:24.04 cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n# docker push cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"NOTE"),": You can get the giteaAdmin password in the same way as you do for the web or git interface."),(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("inlineCode",{parentName:"p"},"idpbuilder get secrets -p gitea")),(0,a.kt)("p",{parentName:"blockquote"},"Or you can use this to login directly:"),(0,a.kt)("pre",{parentName:"blockquote"},(0,a.kt)("code",{parentName:"pre"},"idpbuilder get secrets -p gitea -o json | \\\n  jq '.[0].data.password' -r | \\\n  docker login -u giteaAdmin --password-stdin gitea.cnoe.localtest.me:8443\n"))),(0,a.kt)("h3",{id:"tagging-image"},"Tagging Image"),(0,a.kt)("p",null,"Images pushed to Gitea OCI registry must be tagged with the following naming convention: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"{registry}/{owner}/{image}\n")),(0,a.kt)("p",null,"For example: ",(0,a.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04")),(0,a.kt)("p",null,"This is a naming convention enforced by Gitea. Please see ",(0,a.kt)("a",{parentName:"p",href:"https://docs.gitea.com/usage/packages/container"},"the Gitea documentation")," for more information."),(0,a.kt)("h3",{id:"pulling-images"},"Pulling Images"),(0,a.kt)("p",null,"You can pull an image back to your local machine using your docker client like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"docker pull gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n")),(0,a.kt)("h4",{id:"no-pull-secret-needed"},"No Pull Secret Needed"),(0,a.kt)("p",null,"The Gitea instance allows for anonymous read access. This means that you can pull git repo contents and container images without logging in."),(0,a.kt)("h3",{id:"referencing-images-in-manifests-on-the-idpbuilder-k8s-cluster"},"Referencing Images In Manifests On The Idpbuilder K8s Cluster"),(0,a.kt)("p",null,"You can create a pod or a deployment that references images in the local registry. For example, to create a pod:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\n  namespace: default\n  name: debug-pod\nspec:\n  containers:\n    - image: gitea.cnoe.localtest.me:8443/giteaadmin/ubuntu:24.04\n      name: debug-pod\n      command:\n        - sleep\n        - "3600"\n')),(0,a.kt)("h3",{id:"pulling-images-from-inside-idpbuilder-k8s-cluster"},"Pulling Images From Inside Idpbuilder K8s Cluster:"),(0,a.kt)("p",null,"Because we are using an NGINX Ingress and pushing our image from off cluster,\nGitea and its OCI registry think all images pushed to it are prefixed with ",(0,a.kt)("inlineCode",{parentName:"p"},"gitea.cnoe.localtest.me:8443"),"."),(0,a.kt)("p",null,"This is correct by the OCI spec standards. However, when you are on the cluster, that ingress is not available to you.\nYou can use the service name of gitea, but gitea will not know what images are being asked for at the svc domain name. To work around this issue, we use containerd to rewrite those image names so that they can be referenced at the external url:"),(0,a.kt)("p",null,"See ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cnoe-io/idpbuilder/blob/main/pkg/kind/resources/kind.yaml.tmpl"},"the Kind config")," for how this is done."),(0,a.kt)("h3",{id:"transferring-images-from-remote-registries-to-idbpbuilder"},"Transferring images from remote registries to idbpbuilder"),(0,a.kt)("p",null,"Now that you have a registry up and running at ",(0,a.kt)("inlineCode",{parentName:"p"},"cnoe.localtest.me:8443")," you can copy your images to it. This is especially convenient if you want to pre-load a number of images from some remote before going offline. You can also use this technique to load images into codespaces that are behind a corporate firewall."),(0,a.kt)("p",null,"To make this even easier, you can use a tool like ",(0,a.kt)("a",{parentName:"p",href:"https://oras.land"},"ORAS")," or ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/regclient/regclient"},"regclient")," to copy between them. These tools are beyond the scope of this help document, but at the time of this writing a simple copy command using regclient looks like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'$ regctl registry login cnoe.localtest.me:8443               \nEnter Username [giteaadmin]: giteaadmin\nEnter Password:\n\n$ regctl registry set cnoe.localtest.me:8443 --tls=insecure\ntime=2024-12-29T21:50:58.354-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=insecure host=cnoe.localtest.me:8443\n\n$ regctl image copy docker.io/library/alpine:latest cnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\ntime=2024-12-29T21:50:07.489-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=disabled host=expert-chainsaw-7vjwj6qqgcprjp-8443.app.github.dev\ntime=2024-12-29T21:50:07.489-05:00 level=WARN msg="Changing TLS settings for registry" orig=enabled new=insecure host=cnoe.localtest.me:8443\nManifests: 17/17 | Blobs: 0.000B copied, 0.000B skipped | Elapsed: 0s\ncnoe.localtest.me:8443/gitea/giteaadmin/alpine:latest\n')))}u.isMDXComponent=!0},9203:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/idpbuilder-dns-9462be1aa0af12554e03e841f3b72bfb.png"}}]);