"use strict";(self.webpackChunkcnoe=self.webpackChunkcnoe||[]).push([[1103],{28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>t});var s=i(96540);const r={},o=s.createContext(r);function c(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(o.Provider,{value:n},e.children)}},61754:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"idpbuilder/override","title":"Customizing idpbuilder","description":"Customizing idpbuilder","source":"@site/docs/idpbuilder/override.md","sourceDirName":"idpbuilder","slug":"/idpbuilder/override","permalink":"/docs/idpbuilder/override","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"description":"Customizing idpbuilder","title":"Customizing idpbuilder","index":5},"sidebar":"tutorialSidebar","previous":{"title":"Using IDPBuilder","permalink":"/docs/idpbuilder/usage"},"next":{"title":"Use IDPBuilder Stacks","permalink":"/docs/tutorials/idpbuilder/idpbuilder-stack"}}');var r=i(74848),o=i(28453);const c={sidebar_position:5,description:"Customizing idpbuilder",title:"Customizing idpbuilder",index:5},t=void 0,d={},l=[{value:"Core Packages",id:"core-packages",level:2},{value:"CoreDNS",id:"coredns",level:2},{value:"Self Signed Certificate",id:"self-signed-certificate",level:2}];function a(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"core-packages",children:"Core Packages"}),"\n",(0,r.jsxs)(n.p,{children:["Core Packages are fully customizable with the flag ",(0,r.jsx)(n.code,{children:"-c"}),". This flag accepts a path to a file containing Kubernetes manifests.\nThe specified file can contain multiple yaml documents.\nThe format of this flag is ",(0,r.jsx)(n.code,{children:"<PACKAGE_NAME>:<PATH>"}),". Where ",(0,r.jsx)(n.code,{children:"<PACKAGE_NAME>"})," is one of ",(0,r.jsx)(n.code,{children:"argocd"}),", ",(0,r.jsx)(n.code,{children:"nginx"}),", and ",(0,r.jsx)(n.code,{children:"gitea"}),".\nYou can find the built-in manifests in your local Gitea repositories or in our source files:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/cnoe-io/idpbuilder/blob/main/pkg/controllers/localbuild/resources/argo/install.yaml",children:"ArgoCD"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/cnoe-io/idpbuilder/blob/main/pkg/controllers/localbuild/resources/gitea/k8s/install.yaml",children:"Gitea"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/cnoe-io/idpbuilder/blob/main/pkg/controllers/localbuild/resources/nginx/k8s/ingress-nginx.yaml",children:"Nginx"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For example, if you'd like to override ",(0,r.jsx)(n.a,{href:"https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/",children:"the ArgoCD ConfigMap"}),", you can run idpbuilder like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ idpbuilder create -c argocd:/tmp/override.yaml\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The contents of ",(0,r.jsx)(n.code,{children:"/tmp/override.yaml"})," is:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\ndata:\n  application.resourceTrackingMethod: annotation\n  resource.exclusions: |\n    - kinds:\n        - ProviderConfigUsage\n      apiGroups:\n        - "*"\nkind: ConfigMap\nmetadata:\n  labels:\n    app.kubernetes.io/name: argocd-cm\n    app.kubernetes.io/part-of: argocd\n  name: argocd-cm\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The corresponding built-in manifest can be found ",(0,r.jsx)(n.a,{href:"https://github.com/cnoe-io/idpbuilder/blob/eab34d6c75784f3dce44896e141afbc2a40de03c/pkg/controllers/localbuild/resources/argo/install.yaml#L21082-L21096",children:"here"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["This instructs idpbuilder to use the provided manifest for ",(0,r.jsx)(n.code,{children:"argocd-cm"})," only. The built-in Kubernetes manifests are used for everything but ",(0,r.jsx)(n.code,{children:"argocd-cm"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"coredns",children:"CoreDNS"}),"\n",(0,r.jsxs)(n.p,{children:["CoreDNS is used as the in-cluster DNS provider for Kind clusters. idpbuilder configures CoreDNS service during cluster creation to ensure domain names given by the ",(0,r.jsx)(n.code,{children:"--host"})," flag resolves correctly.\nIt configures CoreDNS by creating a custom CoreDNS configuration files as Kubernetes ConfigMap, then mounting them on the CoreDNS pods.\nThey are not managed by ArgoCD and can be fully customized. If DNS resolutions provided by idpbuilder does not work for you, you can override them with custom packages."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Default CoreDNS configurations"}),":\nThe main configuration file is mounted at ",(0,r.jsx)(n.code,{children:"/etc/coredns/Corefile"})," and looks like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:":53 {\n    errors\n    health {\n       lameduck 5s\n    }\n    ready\n    import ../coredns-configs/*.conf\n    ...\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["CoreDNS allows you to ",(0,r.jsx)(n.a,{href:"https://coredns.io/plugins/import/",children:"import configuration files"})," matching a pattern in a specified directory.\nThe ",(0,r.jsx)(n.code,{children:"import ../coredns-configs/*.conf"})," line instructs CoreDNS to look for configuration files in the ",(0,r.jsx)(n.code,{children:"/etc/coredns-configs/"})," directory."]}),"\n",(0,r.jsxs)(n.p,{children:["idpbuilder creates two ConfigMaps then mount them in the CoreDNS pods under the ",(0,r.jsx)(n.code,{children:"/etc/coredns-configs/"})," directory."]}),"\n",(0,r.jsxs)(n.p,{children:["First ConfigMap is called ",(0,r.jsx)(n.code,{children:"coredns-conf-default"})," and contains configuration like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"rewrite stop {\n    name regex (.*).cnoe.localtest.me ingress-nginx-controller.ingress-nginx.svc.cluster.local\n}\nrewrite name exact cnoe.localtest.me ingress-nginx-controller.ingress-nginx.svc.cluster.local\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The first ",(0,r.jsx)(n.code,{children:"rewrite"})," rule resolves subdomain names to ingress IP address. For example ",(0,r.jsx)(n.code,{children:"gitea.cnoe.localtest.me"})," becomes ",(0,r.jsx)(n.code,{children:"ingress-nginx-controller.ingress-nginx.svc.cluster.local"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The second ",(0,r.jsx)(n.code,{children:"rewrite"})," rule resolves the domain name to ingress IP address. For example  ",(0,r.jsx)(n.code,{children:"cnoe.localtest.me"})," becomes ",(0,r.jsx)(n.code,{children:"ingress-nginx-controller.ingress-nginx.svc.cluster.local"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Second ConfigMap is called ",(0,r.jsx)(n.code,{children:"coredns-conf-custom"})," and is left empty. This is intended to be used by custom packages that need additional DNS resolution.\nFor example, if you'd like to resolve a domain name ",(0,r.jsx)(n.code,{children:"my.cnoe.io"})," to ",(0,r.jsx)(n.code,{children:"home.cnoe.io"}),", then you can populate the CM's data filed like so:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns-conf-custom\n  namespace: kube-system\ndata:\n  custom.conf: |\n    rewrite name exact my.cnoe.io home.cnoe.io\n"})}),"\n",(0,r.jsx)(n.h2,{id:"self-signed-certificate",children:"Self Signed Certificate"}),"\n",(0,r.jsxs)(n.p,{children:["As described in the ",(0,r.jsx)(n.a,{href:"./how-it-works#self-signed-certificate",children:"self-signed certificate"}),", idpbuilder creates a self-signed certificate and uses it as the default TLS certificate for ingress-nginx.\nThis default certificate cannot be overridden at cluster creation and is used when no certificate is specified on the Ingress object.\nThis means, you can specify certificate to use at Ingress level by specifying a TLS secret like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: example-ingress\n  annotations:\n    kubernetes.io/ingress.class: nginx\nspec:\n  tls:\n  - hosts:\n    - cnoe.io\n    secretName: my-tls-secret # specify secret here\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Please see ",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/ingress/",children:"the Kubernetes docs"})," for more information."]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);